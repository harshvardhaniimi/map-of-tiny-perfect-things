<!DOCTYPE html>
<html>

<head>
    <title>WebSocket Client</title>
    <link rel="stylesheet" href="/path/to/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
</head>

<body>
        <!-- Left section -->
        <div id="left-section">
            <h1>Map of Tiny Perfect Things</h1>
            <h2>A subtitle</h2>
            <p>Body</p>
        </div>
    
        <!-- Chat section -->
        <div id="chat-section">
            <div id="chat-container"></div>
            <div id="input-container">
                <input type="text" id="messageInput" placeholder="Type your message">
                <button id="sendButton">Send ⏎</button>
            </div>
        </div>
    
        <!-- Right section -->
        <div id="right-section">
            <h3>Cities & Countries</h3>
            {{ cities|safe }}
        </div>


    <div id="chat-container"></div>
    <div id="input-container">
        <input type="text" id="messageInput" placeholder="Type your message">
        <button id="sendButton">Send ⏎</button>
    </div>
    <script>
        const md = window.markdownit();
        const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

        // Handle messages from server
        socket.on('reply', function (message) {
            const chatContainer = document.getElementById("chat-container");
            const messageDiv = document.createElement("div");
            messageDiv.className = "message gpt-message";
            messageDiv.innerHTML = '<div class="text-box">' + md.render(message) + '</div>';
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // If the response is "Processing your request...", start polling for results
            if (message === "Processing your request...") {
                taskPollingInterval = setInterval(function() {
                    socket.emit('get_result');
                }, 2000); // Poll every 2 seconds
            }
        });

        // Handle task completion status
        socket.on('result_status', function (status) {
            // If the task is still processing, just wait
            // Otherwise, stop the polling
            if (status !== 'Task is still processing...') {
                clearInterval(taskPollingInterval);
            }
        });

        const sendButton = document.getElementById("sendButton");
        const messageInput = document.getElementById("messageInput");

        // Send message to server
        sendButton.addEventListener("click", function () {
            const message = messageInput.value;
            socket.emit('message', message);
            messageInput.value = "";

            const chatContainer = document.getElementById("chat-container");
            const messageDiv = document.createElement("div");
            messageDiv.className = "message user-message";
            messageDiv.innerHTML = '<div class="text-box">' + message + '</div>';
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // Send message with Enter key
        messageInput.addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
                const message = messageInput.value;
                socket.emit('message', message);
                messageInput.value = "";

                const chatContainer = document.getElementById("chat-container");
                const messageDiv = document.createElement("div");
                messageDiv.className = "message user-message";
                messageDiv.innerHTML = '<div class="text-box">' + message + '</div>';
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        });
    </script>
</body>

</html>